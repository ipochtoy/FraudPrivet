# RECONCILIATION SYSTEM PROMPT & ARCHITECTURE

## ğŸ¯ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND                             â”‚
â”‚                     (Blade / Vue / Livewire)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LARAVEL APP                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Parsers    â”‚  â”‚   Matchers   â”‚  â”‚  AI Service  â”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â”‚ â€¢ QuickBooks â”‚  â”‚ â€¢ Direct     â”‚  â”‚ â€¢ Claude API â”‚      â”‚
â”‚  â”‚ â€¢ eBay       â”‚  â”‚ â€¢ Split      â”‚  â”‚ â€¢ Gemini API â”‚      â”‚
â”‚  â”‚ â€¢ Amazon     â”‚  â”‚ â€¢ Discount   â”‚  â”‚ â€¢ Analysis   â”‚      â”‚
â”‚  â”‚ â€¢ Gmail      â”‚  â”‚ â€¢ Fuzzy      â”‚  â”‚ â€¢ Learning   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚              Matching Rules Engine                â”‚      â”‚
â”‚  â”‚         (Dynamic rules from DB + AI)             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MySQL DB                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  transactions â”‚ orders â”‚ matches â”‚ rules â”‚ ai_suggestions  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ DATABASE SCHEMA (MySQL)

```sql
-- Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· QuickBooks
CREATE TABLE transactions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    external_id VARCHAR(100) NULL,
    transaction_date DATE NOT NULL,
    amount DECIMAL(12, 2) NOT NULL,
    vendor VARCHAR(100) NULL,
    vendor_raw VARCHAR(255) NULL,  -- ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
    memo TEXT NULL,
    category VARCHAR(50) NULL,
    source VARCHAR(50) DEFAULT 'quickbooks',
    card_last4 VARCHAR(4) NULL,
    
    -- Matching status
    match_status ENUM('pending', 'matched', 'partial', 'unmatched') DEFAULT 'pending',
    match_confidence DECIMAL(3, 2) NULL,  -- 0.00 - 1.00
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_date (transaction_date),
    INDEX idx_amount (amount),
    INDEX idx_vendor (vendor),
    INDEX idx_status (match_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼
CREATE TABLE orders (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id VARCHAR(100) NOT NULL,
    platform VARCHAR(50) NOT NULL,
    store VARCHAR(100) NULL,
    order_date DATE NOT NULL,
    amount DECIMAL(12, 2) NOT NULL,
    original_amount DECIMAL(12, 2) NULL,
    discount DECIMAL(12, 2) DEFAULT 0,
    client_id VARCHAR(100) NULL,
    client_email VARCHAR(255) NULL,
    
    -- Matching status
    match_status ENUM('pending', 'matched', 'partial', 'unmatched') DEFAULT 'pending',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_order (order_id, platform),
    INDEX idx_date (order_date),
    INDEX idx_amount (amount),
    INDEX idx_platform (platform),
    INDEX idx_status (match_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ…
CREATE TABLE order_items (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT UNSIGNED NOT NULL,
    item_name TEXT NULL,
    quantity INT DEFAULT 1,
    price DECIMAL(12, 2) NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
CREATE TABLE matches (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    match_type ENUM('direct', 'split', 'discount', 'fuzzy', 'manual', 'ai_suggested') NOT NULL,
    confidence DECIMAL(3, 2) NOT NULL DEFAULT 1.00,
    
    order_id BIGINT UNSIGNED NOT NULL,
    
    -- Ğ”Ğ»Ñ direct Ğ¸ discount (Ğ¾Ğ´Ğ½Ğ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ)
    transaction_id BIGINT UNSIGNED NULL,
    
    -- Ğ”Ğ»Ñ split (Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹) - JSON array of IDs
    transaction_ids JSON NULL,
    
    amount_difference DECIMAL(12, 2) DEFAULT 0,
    discount_amount DECIMAL(12, 2) NULL,
    discount_type VARCHAR(50) NULL,
    
    -- AI related
    ai_suggested BOOLEAN DEFAULT FALSE,
    ai_explanation TEXT NULL,
    
    -- Verification
    verified BOOLEAN DEFAULT FALSE,
    verified_by VARCHAR(100) NULL,
    verified_at TIMESTAMP NULL,
    
    notes TEXT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° matching (Ğ¾Ğ±ÑƒÑ‡Ğ°ĞµĞ¼Ñ‹Ğµ!)
CREATE TABLE matching_rules (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT NULL,
    
    -- Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
    vendor_pattern VARCHAR(255) NULL,  -- Regex Ğ¸Ğ»Ğ¸ LIKE
    platform VARCHAR(50) NULL,
    amount_min DECIMAL(12, 2) NULL,
    amount_max DECIMAL(12, 2) NULL,
    
    -- ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ matching
    amount_tolerance DECIMAL(12, 2) DEFAULT 0.10,
    date_tolerance_days INT DEFAULT 3,
    discount_tolerance DECIMAL(12, 2) DEFAULT 0,
    allow_splits BOOLEAN DEFAULT TRUE,
    max_split_parts INT DEFAULT 5,
    
    -- ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    priority INT DEFAULT 100,
    is_active BOOLEAN DEFAULT TRUE,
    
    -- AI related
    created_by ENUM('manual', 'ai_suggested') DEFAULT 'manual',
    ai_confidence DECIMAL(3, 2) NULL,
    times_used INT DEFAULT 0,
    success_rate DECIMAL(5, 2) NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- AI Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ´Ğ»Ñ review)
CREATE TABLE ai_suggestions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    type ENUM('match', 'rule', 'pattern', 'anomaly') NOT NULL,
    
    -- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
    transaction_id BIGINT UNSIGNED NULL,
    order_id BIGINT UNSIGNED NULL,
    
    -- ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
    suggestion JSON NOT NULL,
    explanation TEXT NOT NULL,
    confidence DECIMAL(3, 2) NOT NULL,
    
    -- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ review
    status ENUM('pending', 'accepted', 'rejected', 'modified') DEFAULT 'pending',
    reviewed_by VARCHAR(100) NULL,
    reviewed_at TIMESTAMP NULL,
    review_notes TEXT NULL,
    
    -- ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ
    feedback_applied BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## ğŸ§  AI LOGIC

### AI Learning Loop
1.  **SEE**: AI Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ½Ğ¾Ğ²ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ.
2.  **THINK**: ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°.
3.  **ACT**: ĞŸÑ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‘Ñ‚ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ.
4.  **FEEDBACK**: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚/Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚.
5.  **LEARN**: AI Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°.

### Confidence Levels
-   **95-100%**: Auto action (Auto-match).
-   **80-95%**: Suggest & Confirm.
-   **60-80%**: Suggest multiple options.
-   **40-60%**: Ask clarifying question.
-   **0-40%**: Admit unknown / Request help.

